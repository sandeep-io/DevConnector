{"ast":null,"code":"'use strict';\n\n/*!\n * ignore\n */\nconst get = require('../get');\nconst utils = require('../../utils');\nmodule.exports = applyTimestampsToUpdate;\n\n/*!\n * ignore\n */\n\nfunction applyTimestampsToUpdate(now, createdAt, updatedAt, currentUpdate, options, isReplace) {\n  const updates = currentUpdate;\n  let _updates = updates;\n  const timestamps = get(options, 'timestamps', true);\n\n  // Support skipping timestamps at the query level, see gh-6980\n  if (!timestamps || updates == null) {\n    return currentUpdate;\n  }\n  const skipCreatedAt = timestamps?.createdAt === false;\n  const skipUpdatedAt = timestamps?.updatedAt === false;\n  if (isReplace) {\n    if (currentUpdate?.$set) {\n      currentUpdate = currentUpdate.$set;\n      updates.$set = {};\n      _updates = updates.$set;\n    }\n    if (!skipUpdatedAt && updatedAt && !currentUpdate[updatedAt]) {\n      _updates[updatedAt] = now;\n    }\n    if (!skipCreatedAt && createdAt && !currentUpdate[createdAt]) {\n      _updates[createdAt] = now;\n    }\n    return updates;\n  }\n  currentUpdate = currentUpdate || {};\n  if (Array.isArray(updates)) {\n    // Update with aggregation pipeline\n    if (updatedAt == null) {\n      return updates;\n    }\n    updates.push({\n      $set: {\n        [updatedAt]: now\n      }\n    });\n    return updates;\n  }\n  updates.$set = updates.$set || {};\n  if (!skipUpdatedAt && updatedAt && !currentUpdate.$currentDate?.[updatedAt]) {\n    let timestampSet = false;\n    if (updatedAt.indexOf('.') !== -1) {\n      const pieces = updatedAt.split('.');\n      for (let i = 1; i < pieces.length; ++i) {\n        const remnant = pieces.slice(-i).join('.');\n        const start = pieces.slice(0, -i).join('.');\n        if (currentUpdate[start] != null) {\n          currentUpdate[start][remnant] = now;\n          timestampSet = true;\n          break;\n        } else if (currentUpdate.$set?.[start]) {\n          currentUpdate.$set[start][remnant] = now;\n          timestampSet = true;\n          break;\n        }\n      }\n    }\n    if (!timestampSet) {\n      updates.$set[updatedAt] = now;\n    }\n    if (Object.hasOwn(updates, updatedAt)) {\n      delete updates[updatedAt];\n    }\n  }\n  if (!skipCreatedAt && createdAt) {\n    const overwriteImmutable = get(options, 'overwriteImmutable', false);\n    const hasUserCreatedAt = currentUpdate[createdAt] != null || currentUpdate.$set?.[createdAt] != null;\n\n    // If overwriteImmutable is true and user provided createdAt, keep their value\n    if (overwriteImmutable && hasUserCreatedAt) {\n      // Move createdAt from top-level to $set if needed\n      if (currentUpdate[createdAt] != null) {\n        updates.$set[createdAt] = currentUpdate[createdAt];\n        delete currentUpdate[createdAt];\n      }\n      // User's value is already in $set, nothing more to do\n    } else {\n      if (currentUpdate[createdAt]) {\n        delete currentUpdate[createdAt];\n      }\n      if (currentUpdate.$set?.[createdAt]) {\n        delete currentUpdate.$set[createdAt];\n      }\n      let timestampSet = false;\n      if (createdAt.indexOf('.') !== -1) {\n        const pieces = createdAt.split('.');\n        for (let i = 1; i < pieces.length; ++i) {\n          const remnant = pieces.slice(-i).join('.');\n          const start = pieces.slice(0, -i).join('.');\n          if (currentUpdate[start] != null) {\n            currentUpdate[start][remnant] = now;\n            timestampSet = true;\n            break;\n          } else if (currentUpdate.$set?.[start]) {\n            currentUpdate.$set[start][remnant] = now;\n            timestampSet = true;\n            break;\n          }\n        }\n      }\n      if (!timestampSet) {\n        updates.$setOnInsert = updates.$setOnInsert || {};\n        updates.$setOnInsert[createdAt] = now;\n      }\n    }\n  }\n  if (utils.hasOwnKeys(updates.$set) === false) {\n    delete updates.$set;\n  }\n  return updates;\n}","map":{"version":3,"names":["get","require","utils","module","exports","applyTimestampsToUpdate","now","createdAt","updatedAt","currentUpdate","options","isReplace","updates","_updates","timestamps","skipCreatedAt","skipUpdatedAt","$set","Array","isArray","push","$currentDate","timestampSet","indexOf","pieces","split","i","length","remnant","slice","join","start","Object","hasOwn","overwriteImmutable","hasUserCreatedAt","$setOnInsert","hasOwnKeys"],"sources":["C:/DEVC/node_modules/mongoose/lib/helpers/update/applyTimestampsToUpdate.js"],"sourcesContent":["'use strict';\n\n/*!\n * ignore\n */\n\nconst get = require('../get');\nconst utils = require('../../utils');\n\nmodule.exports = applyTimestampsToUpdate;\n\n/*!\n * ignore\n */\n\nfunction applyTimestampsToUpdate(now, createdAt, updatedAt, currentUpdate, options, isReplace) {\n  const updates = currentUpdate;\n  let _updates = updates;\n  const timestamps = get(options, 'timestamps', true);\n\n  // Support skipping timestamps at the query level, see gh-6980\n  if (!timestamps || updates == null) {\n    return currentUpdate;\n  }\n\n  const skipCreatedAt = timestamps?.createdAt === false;\n  const skipUpdatedAt = timestamps?.updatedAt === false;\n\n  if (isReplace) {\n    if (currentUpdate?.$set) {\n      currentUpdate = currentUpdate.$set;\n      updates.$set = {};\n      _updates = updates.$set;\n    }\n    if (!skipUpdatedAt && updatedAt && !currentUpdate[updatedAt]) {\n      _updates[updatedAt] = now;\n    }\n    if (!skipCreatedAt && createdAt && !currentUpdate[createdAt]) {\n      _updates[createdAt] = now;\n    }\n    return updates;\n  }\n  currentUpdate = currentUpdate || {};\n\n  if (Array.isArray(updates)) {\n    // Update with aggregation pipeline\n    if (updatedAt == null) {\n      return updates;\n    }\n    updates.push({ $set: { [updatedAt]: now } });\n    return updates;\n  }\n  updates.$set = updates.$set || {};\n  if (!skipUpdatedAt && updatedAt &&\n      !currentUpdate.$currentDate?.[updatedAt]) {\n    let timestampSet = false;\n    if (updatedAt.indexOf('.') !== -1) {\n      const pieces = updatedAt.split('.');\n      for (let i = 1; i < pieces.length; ++i) {\n        const remnant = pieces.slice(-i).join('.');\n        const start = pieces.slice(0, -i).join('.');\n        if (currentUpdate[start] != null) {\n          currentUpdate[start][remnant] = now;\n          timestampSet = true;\n          break;\n        } else if (currentUpdate.$set?.[start]) {\n          currentUpdate.$set[start][remnant] = now;\n          timestampSet = true;\n          break;\n        }\n      }\n    }\n\n    if (!timestampSet) {\n      updates.$set[updatedAt] = now;\n    }\n\n    if (Object.hasOwn(updates, updatedAt)) {\n      delete updates[updatedAt];\n    }\n  }\n\n  if (!skipCreatedAt && createdAt) {\n    const overwriteImmutable = get(options, 'overwriteImmutable', false);\n    const hasUserCreatedAt = currentUpdate[createdAt] != null || currentUpdate.$set?.[createdAt] != null;\n\n    // If overwriteImmutable is true and user provided createdAt, keep their value\n    if (overwriteImmutable && hasUserCreatedAt) {\n      // Move createdAt from top-level to $set if needed\n      if (currentUpdate[createdAt] != null) {\n        updates.$set[createdAt] = currentUpdate[createdAt];\n        delete currentUpdate[createdAt];\n      }\n      // User's value is already in $set, nothing more to do\n    } else {\n      if (currentUpdate[createdAt]) {\n        delete currentUpdate[createdAt];\n      }\n      if (currentUpdate.$set?.[createdAt]) {\n        delete currentUpdate.$set[createdAt];\n      }\n      let timestampSet = false;\n      if (createdAt.indexOf('.') !== -1) {\n        const pieces = createdAt.split('.');\n        for (let i = 1; i < pieces.length; ++i) {\n          const remnant = pieces.slice(-i).join('.');\n          const start = pieces.slice(0, -i).join('.');\n          if (currentUpdate[start] != null) {\n            currentUpdate[start][remnant] = now;\n            timestampSet = true;\n            break;\n          } else if (currentUpdate.$set?.[start]) {\n            currentUpdate.$set[start][remnant] = now;\n            timestampSet = true;\n            break;\n          }\n        }\n      }\n\n      if (!timestampSet) {\n        updates.$setOnInsert = updates.$setOnInsert || {};\n        updates.$setOnInsert[createdAt] = now;\n      }\n    }\n  }\n\n  if (utils.hasOwnKeys(updates.$set) === false) {\n    delete updates.$set;\n  }\n  return updates;\n}\n"],"mappings":"AAAA,YAAY;;AAEZ;AACA;AACA;AAEA,MAAMA,GAAG,GAAGC,OAAO,CAAC,QAAQ,CAAC;AAC7B,MAAMC,KAAK,GAAGD,OAAO,CAAC,aAAa,CAAC;AAEpCE,MAAM,CAACC,OAAO,GAAGC,uBAAuB;;AAExC;AACA;AACA;;AAEA,SAASA,uBAAuBA,CAACC,GAAG,EAAEC,SAAS,EAAEC,SAAS,EAAEC,aAAa,EAAEC,OAAO,EAAEC,SAAS,EAAE;EAC7F,MAAMC,OAAO,GAAGH,aAAa;EAC7B,IAAII,QAAQ,GAAGD,OAAO;EACtB,MAAME,UAAU,GAAGd,GAAG,CAACU,OAAO,EAAE,YAAY,EAAE,IAAI,CAAC;;EAEnD;EACA,IAAI,CAACI,UAAU,IAAIF,OAAO,IAAI,IAAI,EAAE;IAClC,OAAOH,aAAa;EACtB;EAEA,MAAMM,aAAa,GAAGD,UAAU,EAAEP,SAAS,KAAK,KAAK;EACrD,MAAMS,aAAa,GAAGF,UAAU,EAAEN,SAAS,KAAK,KAAK;EAErD,IAAIG,SAAS,EAAE;IACb,IAAIF,aAAa,EAAEQ,IAAI,EAAE;MACvBR,aAAa,GAAGA,aAAa,CAACQ,IAAI;MAClCL,OAAO,CAACK,IAAI,GAAG,CAAC,CAAC;MACjBJ,QAAQ,GAAGD,OAAO,CAACK,IAAI;IACzB;IACA,IAAI,CAACD,aAAa,IAAIR,SAAS,IAAI,CAACC,aAAa,CAACD,SAAS,CAAC,EAAE;MAC5DK,QAAQ,CAACL,SAAS,CAAC,GAAGF,GAAG;IAC3B;IACA,IAAI,CAACS,aAAa,IAAIR,SAAS,IAAI,CAACE,aAAa,CAACF,SAAS,CAAC,EAAE;MAC5DM,QAAQ,CAACN,SAAS,CAAC,GAAGD,GAAG;IAC3B;IACA,OAAOM,OAAO;EAChB;EACAH,aAAa,GAAGA,aAAa,IAAI,CAAC,CAAC;EAEnC,IAAIS,KAAK,CAACC,OAAO,CAACP,OAAO,CAAC,EAAE;IAC1B;IACA,IAAIJ,SAAS,IAAI,IAAI,EAAE;MACrB,OAAOI,OAAO;IAChB;IACAA,OAAO,CAACQ,IAAI,CAAC;MAAEH,IAAI,EAAE;QAAE,CAACT,SAAS,GAAGF;MAAI;IAAE,CAAC,CAAC;IAC5C,OAAOM,OAAO;EAChB;EACAA,OAAO,CAACK,IAAI,GAAGL,OAAO,CAACK,IAAI,IAAI,CAAC,CAAC;EACjC,IAAI,CAACD,aAAa,IAAIR,SAAS,IAC3B,CAACC,aAAa,CAACY,YAAY,GAAGb,SAAS,CAAC,EAAE;IAC5C,IAAIc,YAAY,GAAG,KAAK;IACxB,IAAId,SAAS,CAACe,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC,EAAE;MACjC,MAAMC,MAAM,GAAGhB,SAAS,CAACiB,KAAK,CAAC,GAAG,CAAC;MACnC,KAAK,IAAIC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGF,MAAM,CAACG,MAAM,EAAE,EAAED,CAAC,EAAE;QACtC,MAAME,OAAO,GAAGJ,MAAM,CAACK,KAAK,CAAC,CAACH,CAAC,CAAC,CAACI,IAAI,CAAC,GAAG,CAAC;QAC1C,MAAMC,KAAK,GAAGP,MAAM,CAACK,KAAK,CAAC,CAAC,EAAE,CAACH,CAAC,CAAC,CAACI,IAAI,CAAC,GAAG,CAAC;QAC3C,IAAIrB,aAAa,CAACsB,KAAK,CAAC,IAAI,IAAI,EAAE;UAChCtB,aAAa,CAACsB,KAAK,CAAC,CAACH,OAAO,CAAC,GAAGtB,GAAG;UACnCgB,YAAY,GAAG,IAAI;UACnB;QACF,CAAC,MAAM,IAAIb,aAAa,CAACQ,IAAI,GAAGc,KAAK,CAAC,EAAE;UACtCtB,aAAa,CAACQ,IAAI,CAACc,KAAK,CAAC,CAACH,OAAO,CAAC,GAAGtB,GAAG;UACxCgB,YAAY,GAAG,IAAI;UACnB;QACF;MACF;IACF;IAEA,IAAI,CAACA,YAAY,EAAE;MACjBV,OAAO,CAACK,IAAI,CAACT,SAAS,CAAC,GAAGF,GAAG;IAC/B;IAEA,IAAI0B,MAAM,CAACC,MAAM,CAACrB,OAAO,EAAEJ,SAAS,CAAC,EAAE;MACrC,OAAOI,OAAO,CAACJ,SAAS,CAAC;IAC3B;EACF;EAEA,IAAI,CAACO,aAAa,IAAIR,SAAS,EAAE;IAC/B,MAAM2B,kBAAkB,GAAGlC,GAAG,CAACU,OAAO,EAAE,oBAAoB,EAAE,KAAK,CAAC;IACpE,MAAMyB,gBAAgB,GAAG1B,aAAa,CAACF,SAAS,CAAC,IAAI,IAAI,IAAIE,aAAa,CAACQ,IAAI,GAAGV,SAAS,CAAC,IAAI,IAAI;;IAEpG;IACA,IAAI2B,kBAAkB,IAAIC,gBAAgB,EAAE;MAC1C;MACA,IAAI1B,aAAa,CAACF,SAAS,CAAC,IAAI,IAAI,EAAE;QACpCK,OAAO,CAACK,IAAI,CAACV,SAAS,CAAC,GAAGE,aAAa,CAACF,SAAS,CAAC;QAClD,OAAOE,aAAa,CAACF,SAAS,CAAC;MACjC;MACA;IACF,CAAC,MAAM;MACL,IAAIE,aAAa,CAACF,SAAS,CAAC,EAAE;QAC5B,OAAOE,aAAa,CAACF,SAAS,CAAC;MACjC;MACA,IAAIE,aAAa,CAACQ,IAAI,GAAGV,SAAS,CAAC,EAAE;QACnC,OAAOE,aAAa,CAACQ,IAAI,CAACV,SAAS,CAAC;MACtC;MACA,IAAIe,YAAY,GAAG,KAAK;MACxB,IAAIf,SAAS,CAACgB,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC,EAAE;QACjC,MAAMC,MAAM,GAAGjB,SAAS,CAACkB,KAAK,CAAC,GAAG,CAAC;QACnC,KAAK,IAAIC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGF,MAAM,CAACG,MAAM,EAAE,EAAED,CAAC,EAAE;UACtC,MAAME,OAAO,GAAGJ,MAAM,CAACK,KAAK,CAAC,CAACH,CAAC,CAAC,CAACI,IAAI,CAAC,GAAG,CAAC;UAC1C,MAAMC,KAAK,GAAGP,MAAM,CAACK,KAAK,CAAC,CAAC,EAAE,CAACH,CAAC,CAAC,CAACI,IAAI,CAAC,GAAG,CAAC;UAC3C,IAAIrB,aAAa,CAACsB,KAAK,CAAC,IAAI,IAAI,EAAE;YAChCtB,aAAa,CAACsB,KAAK,CAAC,CAACH,OAAO,CAAC,GAAGtB,GAAG;YACnCgB,YAAY,GAAG,IAAI;YACnB;UACF,CAAC,MAAM,IAAIb,aAAa,CAACQ,IAAI,GAAGc,KAAK,CAAC,EAAE;YACtCtB,aAAa,CAACQ,IAAI,CAACc,KAAK,CAAC,CAACH,OAAO,CAAC,GAAGtB,GAAG;YACxCgB,YAAY,GAAG,IAAI;YACnB;UACF;QACF;MACF;MAEA,IAAI,CAACA,YAAY,EAAE;QACjBV,OAAO,CAACwB,YAAY,GAAGxB,OAAO,CAACwB,YAAY,IAAI,CAAC,CAAC;QACjDxB,OAAO,CAACwB,YAAY,CAAC7B,SAAS,CAAC,GAAGD,GAAG;MACvC;IACF;EACF;EAEA,IAAIJ,KAAK,CAACmC,UAAU,CAACzB,OAAO,CAACK,IAAI,CAAC,KAAK,KAAK,EAAE;IAC5C,OAAOL,OAAO,CAACK,IAAI;EACrB;EACA,OAAOL,OAAO;AAChB","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}