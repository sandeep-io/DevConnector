{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.CreateCollectionOperation = void 0;\nexports.createCollections = createCollections;\nconst constants_1 = require(\"../cmap/wire_protocol/constants\");\nconst responses_1 = require(\"../cmap/wire_protocol/responses\");\nconst collection_1 = require(\"../collection\");\nconst error_1 = require(\"../error\");\nconst timeout_1 = require(\"../timeout\");\nconst utils_1 = require(\"../utils\");\nconst command_1 = require(\"./command\");\nconst execute_operation_1 = require(\"./execute_operation\");\nconst indexes_1 = require(\"./indexes\");\nconst operation_1 = require(\"./operation\");\nconst ILLEGAL_COMMAND_FIELDS = new Set(['w', 'wtimeout', 'timeoutMS', 'j', 'fsync', 'pkFactory', 'raw', 'readPreference', 'session', 'readConcern', 'writeConcern', 'raw', 'fieldsAsRaw', 'useBigInt64', 'promoteLongs', 'promoteValues', 'promoteBuffers', 'bsonRegExp', 'serializeFunctions', 'ignoreUndefined', 'enableUtf8Validation']);\n/* @internal */\nconst INVALID_QE_VERSION = 'Driver support of Queryable Encryption is incompatible with server. Upgrade server to use Queryable Encryption.';\n/** @internal */\nclass CreateCollectionOperation extends command_1.CommandOperation {\n  constructor(db, name, options = {}) {\n    super(db, options);\n    this.SERVER_COMMAND_RESPONSE_TYPE = responses_1.MongoDBResponse;\n    this.options = options;\n    this.db = db;\n    this.name = name;\n  }\n  get commandName() {\n    return 'create';\n  }\n  buildCommandDocument(_connection, _session) {\n    const isOptionValid = ([k, v]) => v != null && typeof v !== 'function' && !ILLEGAL_COMMAND_FIELDS.has(k);\n    return {\n      create: this.name,\n      ...Object.fromEntries(Object.entries(this.options).filter(isOptionValid))\n    };\n  }\n  handleOk(_response) {\n    return new collection_1.Collection(this.db, this.name, this.options);\n  }\n}\nexports.CreateCollectionOperation = CreateCollectionOperation;\nasync function createCollections(db, name, options) {\n  const timeoutContext = timeout_1.TimeoutContext.create({\n    session: options.session,\n    serverSelectionTimeoutMS: db.client.s.options.serverSelectionTimeoutMS,\n    waitQueueTimeoutMS: db.client.s.options.waitQueueTimeoutMS,\n    timeoutMS: options.timeoutMS\n  });\n  const encryptedFields = options.encryptedFields ?? db.client.s.options.autoEncryption?.encryptedFieldsMap?.[`${db.databaseName}.${name}`];\n  if (encryptedFields) {\n    class CreateSupportingFLEv2CollectionOperation extends CreateCollectionOperation {\n      buildCommandDocument(connection, session) {\n        if (!connection.description.loadBalanced && (0, utils_1.maxWireVersion)(connection) < constants_1.MIN_SUPPORTED_QE_WIRE_VERSION) {\n          throw new error_1.MongoCompatibilityError(`${INVALID_QE_VERSION} The minimum server version required is ${constants_1.MIN_SUPPORTED_QE_SERVER_VERSION}`);\n        }\n        return super.buildCommandDocument(connection, session);\n      }\n    }\n    // Create auxilliary collections for queryable encryption support.\n    const escCollection = encryptedFields.escCollection ?? `enxcol_.${name}.esc`;\n    const ecocCollection = encryptedFields.ecocCollection ?? `enxcol_.${name}.ecoc`;\n    for (const collectionName of [escCollection, ecocCollection]) {\n      const createOp = new CreateSupportingFLEv2CollectionOperation(db, collectionName, {\n        clusteredIndex: {\n          key: {\n            _id: 1\n          },\n          unique: true\n        },\n        session: options.session\n      });\n      await (0, execute_operation_1.executeOperation)(db.client, createOp, timeoutContext);\n    }\n    if (!options.encryptedFields) {\n      options = {\n        ...options,\n        encryptedFields\n      };\n    }\n  }\n  const coll = await (0, execute_operation_1.executeOperation)(db.client, new CreateCollectionOperation(db, name, options), timeoutContext);\n  if (encryptedFields) {\n    // Create the required index for queryable encryption support.\n    const createIndexOp = indexes_1.CreateIndexesOperation.fromIndexSpecification(db, name, {\n      __safeContent__: 1\n    }, {\n      session: options.session\n    });\n    await (0, execute_operation_1.executeOperation)(db.client, createIndexOp, timeoutContext);\n  }\n  return coll;\n}\n(0, operation_1.defineAspects)(CreateCollectionOperation, [operation_1.Aspect.WRITE_OPERATION]);","map":{"version":3,"names":["exports","createCollections","constants_1","require","responses_1","collection_1","error_1","timeout_1","utils_1","command_1","execute_operation_1","indexes_1","operation_1","ILLEGAL_COMMAND_FIELDS","Set","INVALID_QE_VERSION","CreateCollectionOperation","CommandOperation","constructor","db","name","options","SERVER_COMMAND_RESPONSE_TYPE","MongoDBResponse","commandName","buildCommandDocument","_connection","_session","isOptionValid","k","v","has","create","Object","fromEntries","entries","filter","handleOk","_response","Collection","timeoutContext","TimeoutContext","session","serverSelectionTimeoutMS","client","s","waitQueueTimeoutMS","timeoutMS","encryptedFields","autoEncryption","encryptedFieldsMap","databaseName","CreateSupportingFLEv2CollectionOperation","connection","description","loadBalanced","maxWireVersion","MIN_SUPPORTED_QE_WIRE_VERSION","MongoCompatibilityError","MIN_SUPPORTED_QE_SERVER_VERSION","escCollection","ecocCollection","collectionName","createOp","clusteredIndex","key","_id","unique","executeOperation","coll","createIndexOp","CreateIndexesOperation","fromIndexSpecification","__safeContent__","defineAspects","Aspect","WRITE_OPERATION"],"sources":["C:\\DEVC\\node_modules\\mongodb\\src\\operations\\create_collection.ts"],"sourcesContent":["import { type Connection } from '..';\nimport type { Document } from '../bson';\nimport {\n  MIN_SUPPORTED_QE_SERVER_VERSION,\n  MIN_SUPPORTED_QE_WIRE_VERSION\n} from '../cmap/wire_protocol/constants';\nimport { MongoDBResponse } from '../cmap/wire_protocol/responses';\nimport { Collection } from '../collection';\nimport type { Db } from '../db';\nimport { MongoCompatibilityError } from '../error';\nimport type { PkFactory } from '../mongo_client';\nimport type { ClientSession } from '../sessions';\nimport { TimeoutContext } from '../timeout';\nimport { maxWireVersion } from '../utils';\nimport { CommandOperation, type CommandOperationOptions } from './command';\nimport { executeOperation } from './execute_operation';\nimport { CreateIndexesOperation } from './indexes';\nimport { Aspect, defineAspects } from './operation';\n\nconst ILLEGAL_COMMAND_FIELDS = new Set([\n  'w',\n  'wtimeout',\n  'timeoutMS',\n  'j',\n  'fsync',\n  'pkFactory',\n  'raw',\n  'readPreference',\n  'session',\n  'readConcern',\n  'writeConcern',\n  'raw',\n  'fieldsAsRaw',\n  'useBigInt64',\n  'promoteLongs',\n  'promoteValues',\n  'promoteBuffers',\n  'bsonRegExp',\n  'serializeFunctions',\n  'ignoreUndefined',\n  'enableUtf8Validation'\n]);\n\n/** @public\n * Configuration options for timeseries collections\n * @see https://www.mongodb.com/docs/manual/core/timeseries-collections/\n */\nexport interface TimeSeriesCollectionOptions extends Document {\n  timeField: string;\n  metaField?: string;\n  granularity?: 'seconds' | 'minutes' | 'hours' | string;\n  bucketMaxSpanSeconds?: number;\n  bucketRoundingSeconds?: number;\n}\n\n/** @public\n * Configuration options for clustered collections\n * @see https://www.mongodb.com/docs/manual/core/clustered-collections/\n */\nexport interface ClusteredCollectionOptions extends Document {\n  name?: string;\n  key: Document;\n  unique: boolean;\n}\n\n/** @public */\nexport interface CreateCollectionOptions extends Omit<CommandOperationOptions, 'rawData'> {\n  /** Create a capped collection */\n  capped?: boolean;\n  /** The size of the capped collection in bytes */\n  size?: number;\n  /** The maximum number of documents in the capped collection */\n  max?: number;\n  /** Available for the MMAPv1 storage engine only to set the usePowerOf2Sizes and the noPadding flag */\n  flags?: number;\n  /** Allows users to specify configuration to the storage engine on a per-collection basis when creating a collection */\n  storageEngine?: Document;\n  /** Allows users to specify validation rules or expressions for the collection. For more information, see Document Validation */\n  validator?: Document;\n  /** Determines how strictly MongoDB applies the validation rules to existing documents during an update */\n  validationLevel?: string;\n  /** Determines whether to error on invalid documents or just warn about the violations but allow invalid documents to be inserted */\n  validationAction?: string;\n  /** Allows users to specify a default configuration for indexes when creating a collection */\n  indexOptionDefaults?: Document;\n  /** The name of the source collection or view from which to create the view. The name is not the full namespace of the collection or view (i.e., does not include the database name and implies the same database as the view to create) */\n  viewOn?: string;\n  /** An array that consists of the aggregation pipeline stage. Creates the view by applying the specified pipeline to the viewOn collection or view */\n  pipeline?: Document[];\n  /** A primary key factory function for generation of custom _id keys. */\n  pkFactory?: PkFactory;\n  /** A document specifying configuration options for timeseries collections. */\n  timeseries?: TimeSeriesCollectionOptions;\n  /** A document specifying configuration options for clustered collections. For MongoDB 5.3 and above. */\n  clusteredIndex?: ClusteredCollectionOptions;\n  /** The number of seconds after which a document in a timeseries or clustered collection expires. */\n  expireAfterSeconds?: number;\n  /** @experimental */\n  encryptedFields?: Document;\n  /**\n   * If set, enables pre-update and post-update document events to be included for any\n   * change streams that listen on this collection.\n   */\n  changeStreamPreAndPostImages?: { enabled: boolean };\n}\n\n/* @internal */\nconst INVALID_QE_VERSION =\n  'Driver support of Queryable Encryption is incompatible with server. Upgrade server to use Queryable Encryption.';\n\n/** @internal */\nexport class CreateCollectionOperation extends CommandOperation<Collection> {\n  override SERVER_COMMAND_RESPONSE_TYPE = MongoDBResponse;\n  override options: CreateCollectionOptions;\n  db: Db;\n  name: string;\n\n  constructor(db: Db, name: string, options: CreateCollectionOptions = {}) {\n    super(db, options);\n\n    this.options = options;\n    this.db = db;\n    this.name = name;\n  }\n\n  override get commandName() {\n    return 'create' as const;\n  }\n\n  override buildCommandDocument(_connection: Connection, _session?: ClientSession): Document {\n    const isOptionValid = ([k, v]: [k: string, v: unknown]) =>\n      v != null && typeof v !== 'function' && !ILLEGAL_COMMAND_FIELDS.has(k);\n    return {\n      create: this.name,\n      ...Object.fromEntries(Object.entries(this.options).filter(isOptionValid))\n    };\n  }\n\n  override handleOk(\n    _response: InstanceType<typeof this.SERVER_COMMAND_RESPONSE_TYPE>\n  ): Collection<Document> {\n    return new Collection(this.db, this.name, this.options);\n  }\n}\n\nexport async function createCollections<TSchema extends Document>(\n  db: Db,\n  name: string,\n  options: CreateCollectionOptions\n): Promise<Collection<TSchema>> {\n  const timeoutContext = TimeoutContext.create({\n    session: options.session,\n    serverSelectionTimeoutMS: db.client.s.options.serverSelectionTimeoutMS,\n    waitQueueTimeoutMS: db.client.s.options.waitQueueTimeoutMS,\n    timeoutMS: options.timeoutMS\n  });\n\n  const encryptedFields: Document | undefined =\n    options.encryptedFields ??\n    db.client.s.options.autoEncryption?.encryptedFieldsMap?.[`${db.databaseName}.${name}`];\n\n  if (encryptedFields) {\n    class CreateSupportingFLEv2CollectionOperation extends CreateCollectionOperation {\n      override buildCommandDocument(connection: Connection, session?: ClientSession): Document {\n        if (\n          !connection.description.loadBalanced &&\n          maxWireVersion(connection) < MIN_SUPPORTED_QE_WIRE_VERSION\n        ) {\n          throw new MongoCompatibilityError(\n            `${INVALID_QE_VERSION} The minimum server version required is ${MIN_SUPPORTED_QE_SERVER_VERSION}`\n          );\n        }\n\n        return super.buildCommandDocument(connection, session);\n      }\n    }\n\n    // Create auxilliary collections for queryable encryption support.\n    const escCollection = encryptedFields.escCollection ?? `enxcol_.${name}.esc`;\n    const ecocCollection = encryptedFields.ecocCollection ?? `enxcol_.${name}.ecoc`;\n\n    for (const collectionName of [escCollection, ecocCollection]) {\n      const createOp = new CreateSupportingFLEv2CollectionOperation(db, collectionName, {\n        clusteredIndex: {\n          key: { _id: 1 },\n          unique: true\n        },\n        session: options.session\n      });\n      await executeOperation(db.client, createOp, timeoutContext);\n    }\n\n    if (!options.encryptedFields) {\n      options = { ...options, encryptedFields };\n    }\n  }\n\n  const coll = await executeOperation(\n    db.client,\n    new CreateCollectionOperation(db, name, options),\n    timeoutContext\n  );\n\n  if (encryptedFields) {\n    // Create the required index for queryable encryption support.\n    const createIndexOp = CreateIndexesOperation.fromIndexSpecification(\n      db,\n      name,\n      { __safeContent__: 1 },\n      { session: options.session }\n    );\n    await executeOperation(db.client, createIndexOp, timeoutContext);\n  }\n\n  return coll as unknown as Collection<TSchema>;\n}\n\ndefineAspects(CreateCollectionOperation, [Aspect.WRITE_OPERATION]);\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}