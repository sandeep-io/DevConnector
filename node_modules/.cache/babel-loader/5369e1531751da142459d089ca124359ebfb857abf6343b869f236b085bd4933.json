{"ast":null,"code":"'use strict';\n\nconst objectIdSymbol = require('../helpers/symbols').objectIdSymbol;\nconst utils = require('../utils');\n\n/*!\n * ignore\n */\n\nmodule.exports = function shardingPlugin(schema) {\n  schema.post('init', function shardingPluginPostInit() {\n    storeShard.call(this);\n    return this;\n  });\n  schema.pre('save', function shardingPluginPreSave() {\n    applyWhere.call(this);\n  });\n  schema.pre('deleteOne', {\n    document: true,\n    query: false\n  }, function shardingPluginPreDeleteOne() {\n    applyWhere.call(this);\n  });\n  schema.pre('updateOne', {\n    document: true,\n    query: false\n  }, function shardingPluginPreUpdateOne() {\n    applyWhere.call(this);\n  });\n  schema.post('save', function shardingPluginPostSave() {\n    storeShard.call(this);\n  });\n};\n\n/*!\n * ignore\n */\n\nfunction applyWhere() {\n  let paths;\n  let len;\n  if (this.$__.shardval) {\n    paths = Object.keys(this.$__.shardval);\n    len = paths.length;\n    this.$where = this.$where || {};\n    for (let i = 0; i < len; ++i) {\n      this.$where[paths[i]] = this.$__.shardval[paths[i]];\n    }\n  }\n}\n\n/*!\n * ignore\n */\n\nmodule.exports.storeShard = storeShard;\n\n/*!\n * ignore\n */\n\nfunction storeShard() {\n  // backwards compat\n  const key = this.$__schema.options.shardKey || this.$__schema.options.shardkey;\n  if (!utils.isPOJO(key)) {\n    return;\n  }\n  const orig = this.$__.shardval = {};\n  const paths = Object.keys(key);\n  const len = paths.length;\n  let val;\n  for (let i = 0; i < len; ++i) {\n    val = this.$__getValue(paths[i]);\n    if (val == null) {\n      orig[paths[i]] = val;\n    } else if (utils.isMongooseObject(val)) {\n      orig[paths[i]] = val.toObject({\n        depopulate: true,\n        _isNested: true\n      });\n    } else if (val instanceof Date || val[objectIdSymbol]) {\n      orig[paths[i]] = val;\n    } else if (typeof val.valueOf === 'function') {\n      orig[paths[i]] = val.valueOf();\n    } else {\n      orig[paths[i]] = val;\n    }\n  }\n}","map":{"version":3,"names":["objectIdSymbol","require","utils","module","exports","shardingPlugin","schema","post","shardingPluginPostInit","storeShard","call","pre","shardingPluginPreSave","applyWhere","document","query","shardingPluginPreDeleteOne","shardingPluginPreUpdateOne","shardingPluginPostSave","paths","len","$__","shardval","Object","keys","length","$where","i","key","$__schema","options","shardKey","shardkey","isPOJO","orig","val","$__getValue","isMongooseObject","toObject","depopulate","_isNested","Date","valueOf"],"sources":["C:/DEVC/node_modules/mongoose/lib/plugins/sharding.js"],"sourcesContent":["'use strict';\n\nconst objectIdSymbol = require('../helpers/symbols').objectIdSymbol;\nconst utils = require('../utils');\n\n/*!\n * ignore\n */\n\nmodule.exports = function shardingPlugin(schema) {\n  schema.post('init', function shardingPluginPostInit() {\n    storeShard.call(this);\n    return this;\n  });\n  schema.pre('save', function shardingPluginPreSave() {\n    applyWhere.call(this);\n  });\n  schema.pre('deleteOne', { document: true, query: false }, function shardingPluginPreDeleteOne() {\n    applyWhere.call(this);\n  });\n  schema.pre('updateOne', { document: true, query: false }, function shardingPluginPreUpdateOne() {\n    applyWhere.call(this);\n  });\n  schema.post('save', function shardingPluginPostSave() {\n    storeShard.call(this);\n  });\n};\n\n/*!\n * ignore\n */\n\nfunction applyWhere() {\n  let paths;\n  let len;\n\n  if (this.$__.shardval) {\n    paths = Object.keys(this.$__.shardval);\n    len = paths.length;\n\n    this.$where = this.$where || {};\n    for (let i = 0; i < len; ++i) {\n      this.$where[paths[i]] = this.$__.shardval[paths[i]];\n    }\n  }\n}\n\n/*!\n * ignore\n */\n\nmodule.exports.storeShard = storeShard;\n\n/*!\n * ignore\n */\n\nfunction storeShard() {\n  // backwards compat\n  const key = this.$__schema.options.shardKey || this.$__schema.options.shardkey;\n  if (!utils.isPOJO(key)) {\n    return;\n  }\n\n  const orig = this.$__.shardval = {};\n  const paths = Object.keys(key);\n  const len = paths.length;\n  let val;\n\n  for (let i = 0; i < len; ++i) {\n    val = this.$__getValue(paths[i]);\n    if (val == null) {\n      orig[paths[i]] = val;\n    } else if (utils.isMongooseObject(val)) {\n      orig[paths[i]] = val.toObject({ depopulate: true, _isNested: true });\n    } else if (val instanceof Date || val[objectIdSymbol]) {\n      orig[paths[i]] = val;\n    } else if (typeof val.valueOf === 'function') {\n      orig[paths[i]] = val.valueOf();\n    } else {\n      orig[paths[i]] = val;\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}