{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.CommandOperation = void 0;\nconst constants_1 = require(\"../cmap/wire_protocol/constants\");\nconst error_1 = require(\"../error\");\nconst explain_1 = require(\"../explain\");\nconst read_concern_1 = require(\"../read_concern\");\nconst utils_1 = require(\"../utils\");\nconst write_concern_1 = require(\"../write_concern\");\nconst operation_1 = require(\"./operation\");\n/** @internal */\nclass CommandOperation extends operation_1.AbstractOperation {\n  constructor(parent, options) {\n    super(options);\n    this.options = options ?? {};\n    // NOTE: this was explicitly added for the add/remove user operations, it's likely\n    //       something we'd want to reconsider. Perhaps those commands can use `Admin`\n    //       as a parent?\n    const dbNameOverride = options?.dbName || options?.authdb;\n    if (dbNameOverride) {\n      this.ns = new utils_1.MongoDBNamespace(dbNameOverride, '$cmd');\n    } else {\n      this.ns = parent ? parent.s.namespace.withCollection('$cmd') : new utils_1.MongoDBNamespace('admin', '$cmd');\n    }\n    this.readConcern = read_concern_1.ReadConcern.fromOptions(options);\n    this.writeConcern = write_concern_1.WriteConcern.fromOptions(options);\n    if (this.hasAspect(operation_1.Aspect.EXPLAINABLE)) {\n      this.explain = explain_1.Explain.fromOptions(options);\n      if (this.explain) (0, explain_1.validateExplainTimeoutOptions)(this.options, this.explain);\n    } else if (options?.explain != null) {\n      throw new error_1.MongoInvalidArgumentError(`Option \"explain\" is not supported on this command`);\n    }\n  }\n  get canRetryWrite() {\n    if (this.hasAspect(operation_1.Aspect.EXPLAINABLE)) {\n      return this.explain == null;\n    }\n    return super.canRetryWrite;\n  }\n  buildOptions(timeoutContext) {\n    return {\n      ...this.options,\n      ...this.bsonOptions,\n      timeoutContext,\n      readPreference: this.readPreference,\n      session: this.session\n    };\n  }\n  buildCommand(connection, session) {\n    const command = this.buildCommandDocument(connection, session);\n    const inTransaction = this.session && this.session.inTransaction();\n    if (this.readConcern && (0, utils_1.commandSupportsReadConcern)(command) && !inTransaction) {\n      Object.assign(command, {\n        readConcern: this.readConcern\n      });\n    }\n    if (this.writeConcern && this.hasAspect(operation_1.Aspect.WRITE_OPERATION) && !inTransaction) {\n      write_concern_1.WriteConcern.apply(command, this.writeConcern);\n    }\n    if (this.options.collation && typeof this.options.collation === 'object' && !this.hasAspect(operation_1.Aspect.SKIP_COLLATION)) {\n      Object.assign(command, {\n        collation: this.options.collation\n      });\n    }\n    if (typeof this.options.maxTimeMS === 'number') {\n      command.maxTimeMS = this.options.maxTimeMS;\n    }\n    if (this.options.rawData != null && this.hasAspect(operation_1.Aspect.SUPPORTS_RAW_DATA) && (0, utils_1.maxWireVersion)(connection) >= constants_1.MIN_SUPPORTED_RAW_DATA_WIRE_VERSION) {\n      command.rawData = this.options.rawData;\n    }\n    if (this.hasAspect(operation_1.Aspect.EXPLAINABLE) && this.explain) {\n      return (0, explain_1.decorateWithExplain)(command, this.explain);\n    }\n    return command;\n  }\n}\nexports.CommandOperation = CommandOperation;","map":{"version":3,"names":["constants_1","require","error_1","explain_1","read_concern_1","utils_1","write_concern_1","operation_1","CommandOperation","AbstractOperation","constructor","parent","options","dbNameOverride","dbName","authdb","ns","MongoDBNamespace","s","namespace","withCollection","readConcern","ReadConcern","fromOptions","writeConcern","WriteConcern","hasAspect","Aspect","EXPLAINABLE","explain","Explain","validateExplainTimeoutOptions","MongoInvalidArgumentError","canRetryWrite","buildOptions","timeoutContext","bsonOptions","readPreference","session","buildCommand","connection","command","buildCommandDocument","inTransaction","commandSupportsReadConcern","Object","assign","WRITE_OPERATION","apply","collation","SKIP_COLLATION","maxTimeMS","rawData","SUPPORTS_RAW_DATA","maxWireVersion","MIN_SUPPORTED_RAW_DATA_WIRE_VERSION","decorateWithExplain","exports"],"sources":["C:\\DEVC\\node_modules\\mongodb\\src\\operations\\command.ts"],"sourcesContent":["import { type Connection } from '..';\nimport type { BSONSerializeOptions, Document } from '../bson';\nimport { MIN_SUPPORTED_RAW_DATA_WIRE_VERSION } from '../cmap/wire_protocol/constants';\nimport { MongoInvalidArgumentError } from '../error';\nimport {\n  decorateWithExplain,\n  Explain,\n  type ExplainOptions,\n  validateExplainTimeoutOptions\n} from '../explain';\nimport { ReadConcern } from '../read_concern';\nimport type { ReadPreference } from '../read_preference';\nimport type { ServerCommandOptions } from '../sdam/server';\nimport type { ClientSession } from '../sessions';\nimport { type TimeoutContext } from '../timeout';\nimport { commandSupportsReadConcern, maxWireVersion, MongoDBNamespace } from '../utils';\nimport { WriteConcern, type WriteConcernOptions } from '../write_concern';\nimport type { ReadConcernLike } from './../read_concern';\nimport { AbstractOperation, Aspect, type OperationOptions } from './operation';\n\n/** @public */\nexport interface CollationOptions {\n  locale: string;\n  caseLevel?: boolean;\n  caseFirst?: string;\n  strength?: number;\n  numericOrdering?: boolean;\n  alternate?: string;\n  maxVariable?: string;\n  backwards?: boolean;\n  normalization?: boolean;\n}\n\n/** @public */\nexport interface CommandOperationOptions\n  extends OperationOptions,\n    WriteConcernOptions,\n    ExplainOptions {\n  /** Specify a read concern and level for the collection. (only MongoDB 3.2 or higher supported) */\n  readConcern?: ReadConcernLike;\n  /** Collation */\n  collation?: CollationOptions;\n  /**\n   * maxTimeMS is a server-side time limit in milliseconds for processing an operation.\n   */\n  maxTimeMS?: number;\n  /**\n   * Comment to apply to the operation.\n   *\n   * In server versions pre-4.4, 'comment' must be string.  A server\n   * error will be thrown if any other type is provided.\n   *\n   * In server versions 4.4 and above, 'comment' can be any valid BSON type.\n   */\n  comment?: unknown;\n  // Admin command overrides.\n  dbName?: string;\n  authdb?: string;\n\n  /**\n   * Used when the command needs to grant access to the underlying namespaces for time series collections.\n   * Only available on server versions 8.2 and above and is not meant for public use.\n   * @internal\n   * @sinceServerVersion 8.2\n   **/\n  rawData?: boolean;\n}\n\n/** @internal */\nexport interface OperationParent {\n  s: { namespace: MongoDBNamespace };\n  readConcern?: ReadConcern;\n  writeConcern?: WriteConcern;\n  readPreference?: ReadPreference;\n  bsonOptions?: BSONSerializeOptions;\n  timeoutMS?: number;\n}\n\n/** @internal */\nexport abstract class CommandOperation<T> extends AbstractOperation<T> {\n  override options: CommandOperationOptions;\n  readConcern?: ReadConcern;\n  writeConcern?: WriteConcern;\n  explain?: Explain;\n\n  constructor(parent?: OperationParent, options?: CommandOperationOptions) {\n    super(options);\n    this.options = options ?? {};\n\n    // NOTE: this was explicitly added for the add/remove user operations, it's likely\n    //       something we'd want to reconsider. Perhaps those commands can use `Admin`\n    //       as a parent?\n    const dbNameOverride = options?.dbName || options?.authdb;\n    if (dbNameOverride) {\n      this.ns = new MongoDBNamespace(dbNameOverride, '$cmd');\n    } else {\n      this.ns = parent\n        ? parent.s.namespace.withCollection('$cmd')\n        : new MongoDBNamespace('admin', '$cmd');\n    }\n\n    this.readConcern = ReadConcern.fromOptions(options);\n    this.writeConcern = WriteConcern.fromOptions(options);\n\n    if (this.hasAspect(Aspect.EXPLAINABLE)) {\n      this.explain = Explain.fromOptions(options);\n      if (this.explain) validateExplainTimeoutOptions(this.options, this.explain);\n    } else if (options?.explain != null) {\n      throw new MongoInvalidArgumentError(`Option \"explain\" is not supported on this command`);\n    }\n  }\n\n  override get canRetryWrite(): boolean {\n    if (this.hasAspect(Aspect.EXPLAINABLE)) {\n      return this.explain == null;\n    }\n    return super.canRetryWrite;\n  }\n\n  abstract buildCommandDocument(connection: Connection, session?: ClientSession): Document;\n\n  override buildOptions(timeoutContext: TimeoutContext): ServerCommandOptions {\n    return {\n      ...this.options,\n      ...this.bsonOptions,\n      timeoutContext,\n      readPreference: this.readPreference,\n      session: this.session\n    };\n  }\n\n  override buildCommand(connection: Connection, session?: ClientSession): Document {\n    const command = this.buildCommandDocument(connection, session);\n\n    const inTransaction = this.session && this.session.inTransaction();\n\n    if (this.readConcern && commandSupportsReadConcern(command) && !inTransaction) {\n      Object.assign(command, { readConcern: this.readConcern });\n    }\n\n    if (this.writeConcern && this.hasAspect(Aspect.WRITE_OPERATION) && !inTransaction) {\n      WriteConcern.apply(command, this.writeConcern);\n    }\n\n    if (\n      this.options.collation &&\n      typeof this.options.collation === 'object' &&\n      !this.hasAspect(Aspect.SKIP_COLLATION)\n    ) {\n      Object.assign(command, { collation: this.options.collation });\n    }\n\n    if (typeof this.options.maxTimeMS === 'number') {\n      command.maxTimeMS = this.options.maxTimeMS;\n    }\n\n    if (\n      this.options.rawData != null &&\n      this.hasAspect(Aspect.SUPPORTS_RAW_DATA) &&\n      maxWireVersion(connection) >= MIN_SUPPORTED_RAW_DATA_WIRE_VERSION\n    ) {\n      command.rawData = this.options.rawData;\n    }\n\n    if (this.hasAspect(Aspect.EXPLAINABLE) && this.explain) {\n      return decorateWithExplain(command, this.explain);\n    }\n\n    return command;\n  }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}