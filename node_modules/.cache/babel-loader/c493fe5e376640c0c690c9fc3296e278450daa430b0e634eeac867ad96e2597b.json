{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.AWSSDKCredentialProvider = void 0;\nconst deps_1 = require(\"../../deps\");\nconst error_1 = require(\"../../error\");\n/** @internal */\nclass AWSSDKCredentialProvider {\n  /**\n   * Create the SDK credentials provider.\n   * @param credentialsProvider - The credentials provider.\n   */\n  constructor(credentialsProvider) {\n    if (credentialsProvider) {\n      this._provider = credentialsProvider;\n    }\n  }\n  static get awsSDK() {\n    AWSSDKCredentialProvider._awsSDK ??= (0, deps_1.getAwsCredentialProvider)();\n    return AWSSDKCredentialProvider._awsSDK;\n  }\n  /**\n   * The AWS SDK caches credentials automatically and handles refresh when the credentials have expired.\n   * To ensure this occurs, we need to cache the `provider` returned by the AWS sdk and re-use it when fetching credentials.\n   */\n  get provider() {\n    if ('kModuleError' in AWSSDKCredentialProvider.awsSDK) {\n      throw AWSSDKCredentialProvider.awsSDK.kModuleError;\n    }\n    if (this._provider) {\n      return this._provider;\n    }\n    let {\n      AWS_STS_REGIONAL_ENDPOINTS = '',\n      AWS_REGION = ''\n    } = process.env;\n    AWS_STS_REGIONAL_ENDPOINTS = AWS_STS_REGIONAL_ENDPOINTS.toLowerCase();\n    AWS_REGION = AWS_REGION.toLowerCase();\n    /** The option setting should work only for users who have explicit settings in their environment, the driver should not encode \"defaults\" */\n    const awsRegionSettingsExist = AWS_REGION.length !== 0 && AWS_STS_REGIONAL_ENDPOINTS.length !== 0;\n    /**\n     * The following regions use the global AWS STS endpoint, sts.amazonaws.com, by default\n     * https://docs.aws.amazon.com/sdkref/latest/guide/feature-sts-regionalized-endpoints.html\n     */\n    const LEGACY_REGIONS = new Set(['ap-northeast-1', 'ap-south-1', 'ap-southeast-1', 'ap-southeast-2', 'aws-global', 'ca-central-1', 'eu-central-1', 'eu-north-1', 'eu-west-1', 'eu-west-2', 'eu-west-3', 'sa-east-1', 'us-east-1', 'us-east-2', 'us-west-1', 'us-west-2']);\n    /**\n     * If AWS_STS_REGIONAL_ENDPOINTS is set to regional, users are opting into the new behavior of respecting the region settings\n     *\n     * If AWS_STS_REGIONAL_ENDPOINTS is set to legacy, then \"old\" regions need to keep using the global setting.\n     * Technically the SDK gets this wrong, it reaches out to 'sts.us-east-1.amazonaws.com' when it should be 'sts.amazonaws.com'.\n     * That is not our bug to fix here. We leave that up to the SDK.\n     */\n    const useRegionalSts = AWS_STS_REGIONAL_ENDPOINTS === 'regional' || AWS_STS_REGIONAL_ENDPOINTS === 'legacy' && !LEGACY_REGIONS.has(AWS_REGION);\n    this._provider = awsRegionSettingsExist && useRegionalSts ? AWSSDKCredentialProvider.awsSDK.fromNodeProviderChain({\n      clientConfig: {\n        region: AWS_REGION\n      }\n    }) : AWSSDKCredentialProvider.awsSDK.fromNodeProviderChain();\n    return this._provider;\n  }\n  async getCredentials() {\n    /*\n     * Creates a credential provider that will attempt to find credentials from the\n     * following sources (listed in order of precedence):\n     *\n     * - Environment variables exposed via process.env\n     * - SSO credentials from token cache\n     * - Web identity token credentials\n     * - Shared credentials and config ini files\n     * - The EC2/ECS Instance Metadata Service\n     */\n    try {\n      const creds = await this.provider();\n      return {\n        AccessKeyId: creds.accessKeyId,\n        SecretAccessKey: creds.secretAccessKey,\n        Token: creds.sessionToken,\n        Expiration: creds.expiration\n      };\n    } catch (error) {\n      throw new error_1.MongoAWSError(error.message, {\n        cause: error\n      });\n    }\n  }\n}\nexports.AWSSDKCredentialProvider = AWSSDKCredentialProvider;","map":{"version":3,"names":["deps_1","require","error_1","AWSSDKCredentialProvider","constructor","credentialsProvider","_provider","awsSDK","_awsSDK","getAwsCredentialProvider","provider","kModuleError","AWS_STS_REGIONAL_ENDPOINTS","AWS_REGION","process","env","toLowerCase","awsRegionSettingsExist","length","LEGACY_REGIONS","Set","useRegionalSts","has","fromNodeProviderChain","clientConfig","region","getCredentials","creds","AccessKeyId","accessKeyId","SecretAccessKey","secretAccessKey","Token","sessionToken","Expiration","expiration","error","MongoAWSError","message","cause","exports"],"sources":["C:\\DEVC\\node_modules\\mongodb\\src\\cmap\\auth\\aws_temporary_credentials.ts"],"sourcesContent":["import { type AWSCredentials, getAwsCredentialProvider } from '../../deps';\nimport { MongoAWSError } from '../../error';\n\n/**\n * @internal\n * This interface matches the final result of fetching temporary credentials manually, outlined\n * in the spec [here](https://github.com/mongodb/specifications/blob/master/source/auth/auth.md#ec2-endpoint).\n *\n * When we use the AWS SDK, we map the response from the SDK to conform to this interface.\n */\nexport interface AWSTempCredentials {\n  AccessKeyId?: string;\n  SecretAccessKey?: string;\n  Token?: string;\n  RoleArn?: string;\n  Expiration?: Date;\n}\n\n/** @public **/\nexport type AWSCredentialProvider = () => Promise<AWSCredentials>;\n\n/** @internal */\nexport class AWSSDKCredentialProvider {\n  private static _awsSDK: ReturnType<typeof getAwsCredentialProvider>;\n  private _provider?: AWSCredentialProvider;\n\n  /**\n   * Create the SDK credentials provider.\n   * @param credentialsProvider - The credentials provider.\n   */\n  constructor(credentialsProvider?: AWSCredentialProvider) {\n    if (credentialsProvider) {\n      this._provider = credentialsProvider;\n    }\n  }\n\n  static get awsSDK() {\n    AWSSDKCredentialProvider._awsSDK ??= getAwsCredentialProvider();\n    return AWSSDKCredentialProvider._awsSDK;\n  }\n\n  /**\n   * The AWS SDK caches credentials automatically and handles refresh when the credentials have expired.\n   * To ensure this occurs, we need to cache the `provider` returned by the AWS sdk and re-use it when fetching credentials.\n   */\n  private get provider(): () => Promise<AWSCredentials> {\n    if ('kModuleError' in AWSSDKCredentialProvider.awsSDK) {\n      throw AWSSDKCredentialProvider.awsSDK.kModuleError;\n    }\n    if (this._provider) {\n      return this._provider;\n    }\n    let { AWS_STS_REGIONAL_ENDPOINTS = '', AWS_REGION = '' } = process.env;\n    AWS_STS_REGIONAL_ENDPOINTS = AWS_STS_REGIONAL_ENDPOINTS.toLowerCase();\n    AWS_REGION = AWS_REGION.toLowerCase();\n\n    /** The option setting should work only for users who have explicit settings in their environment, the driver should not encode \"defaults\" */\n    const awsRegionSettingsExist =\n      AWS_REGION.length !== 0 && AWS_STS_REGIONAL_ENDPOINTS.length !== 0;\n\n    /**\n     * The following regions use the global AWS STS endpoint, sts.amazonaws.com, by default\n     * https://docs.aws.amazon.com/sdkref/latest/guide/feature-sts-regionalized-endpoints.html\n     */\n    const LEGACY_REGIONS = new Set([\n      'ap-northeast-1',\n      'ap-south-1',\n      'ap-southeast-1',\n      'ap-southeast-2',\n      'aws-global',\n      'ca-central-1',\n      'eu-central-1',\n      'eu-north-1',\n      'eu-west-1',\n      'eu-west-2',\n      'eu-west-3',\n      'sa-east-1',\n      'us-east-1',\n      'us-east-2',\n      'us-west-1',\n      'us-west-2'\n    ]);\n    /**\n     * If AWS_STS_REGIONAL_ENDPOINTS is set to regional, users are opting into the new behavior of respecting the region settings\n     *\n     * If AWS_STS_REGIONAL_ENDPOINTS is set to legacy, then \"old\" regions need to keep using the global setting.\n     * Technically the SDK gets this wrong, it reaches out to 'sts.us-east-1.amazonaws.com' when it should be 'sts.amazonaws.com'.\n     * That is not our bug to fix here. We leave that up to the SDK.\n     */\n    const useRegionalSts =\n      AWS_STS_REGIONAL_ENDPOINTS === 'regional' ||\n      (AWS_STS_REGIONAL_ENDPOINTS === 'legacy' && !LEGACY_REGIONS.has(AWS_REGION));\n\n    this._provider =\n      awsRegionSettingsExist && useRegionalSts\n        ? AWSSDKCredentialProvider.awsSDK.fromNodeProviderChain({\n            clientConfig: { region: AWS_REGION }\n          })\n        : AWSSDKCredentialProvider.awsSDK.fromNodeProviderChain();\n\n    return this._provider;\n  }\n\n  async getCredentials(): Promise<AWSTempCredentials> {\n    /*\n     * Creates a credential provider that will attempt to find credentials from the\n     * following sources (listed in order of precedence):\n     *\n     * - Environment variables exposed via process.env\n     * - SSO credentials from token cache\n     * - Web identity token credentials\n     * - Shared credentials and config ini files\n     * - The EC2/ECS Instance Metadata Service\n     */\n    try {\n      const creds = await this.provider();\n      return {\n        AccessKeyId: creds.accessKeyId,\n        SecretAccessKey: creds.secretAccessKey,\n        Token: creds.sessionToken,\n        Expiration: creds.expiration\n      };\n    } catch (error) {\n      throw new MongoAWSError(error.message, { cause: error });\n    }\n  }\n}\n"],"mappings":";;;;;;AAAA,MAAAA,MAAA,GAAAC,OAAA;AACA,MAAAC,OAAA,GAAAD,OAAA;AAoBA;AACA,MAAaE,wBAAwB;EAInC;;;;EAIAC,YAAYC,mBAA2C;IACrD,IAAIA,mBAAmB,EAAE;MACvB,IAAI,CAACC,SAAS,GAAGD,mBAAmB;IACtC;EACF;EAEA,WAAWE,MAAMA,CAAA;IACfJ,wBAAwB,CAACK,OAAO,KAAK,IAAAR,MAAA,CAAAS,wBAAwB,GAAE;IAC/D,OAAON,wBAAwB,CAACK,OAAO;EACzC;EAEA;;;;EAIA,IAAYE,QAAQA,CAAA;IAClB,IAAI,cAAc,IAAIP,wBAAwB,CAACI,MAAM,EAAE;MACrD,MAAMJ,wBAAwB,CAACI,MAAM,CAACI,YAAY;IACpD;IACA,IAAI,IAAI,CAACL,SAAS,EAAE;MAClB,OAAO,IAAI,CAACA,SAAS;IACvB;IACA,IAAI;MAAEM,0BAA0B,GAAG,EAAE;MAAEC,UAAU,GAAG;IAAE,CAAE,GAAGC,OAAO,CAACC,GAAG;IACtEH,0BAA0B,GAAGA,0BAA0B,CAACI,WAAW,EAAE;IACrEH,UAAU,GAAGA,UAAU,CAACG,WAAW,EAAE;IAErC;IACA,MAAMC,sBAAsB,GAC1BJ,UAAU,CAACK,MAAM,KAAK,CAAC,IAAIN,0BAA0B,CAACM,MAAM,KAAK,CAAC;IAEpE;;;;IAIA,MAAMC,cAAc,GAAG,IAAIC,GAAG,CAAC,CAC7B,gBAAgB,EAChB,YAAY,EACZ,gBAAgB,EAChB,gBAAgB,EAChB,YAAY,EACZ,cAAc,EACd,cAAc,EACd,YAAY,EACZ,WAAW,EACX,WAAW,EACX,WAAW,EACX,WAAW,EACX,WAAW,EACX,WAAW,EACX,WAAW,EACX,WAAW,CACZ,CAAC;IACF;;;;;;;IAOA,MAAMC,cAAc,GAClBT,0BAA0B,KAAK,UAAU,IACxCA,0BAA0B,KAAK,QAAQ,IAAI,CAACO,cAAc,CAACG,GAAG,CAACT,UAAU,CAAE;IAE9E,IAAI,CAACP,SAAS,GACZW,sBAAsB,IAAII,cAAc,GACpClB,wBAAwB,CAACI,MAAM,CAACgB,qBAAqB,CAAC;MACpDC,YAAY,EAAE;QAAEC,MAAM,EAAEZ;MAAU;KACnC,CAAC,GACFV,wBAAwB,CAACI,MAAM,CAACgB,qBAAqB,EAAE;IAE7D,OAAO,IAAI,CAACjB,SAAS;EACvB;EAEA,MAAMoB,cAAcA,CAAA;IAClB;;;;;;;;;;IAUA,IAAI;MACF,MAAMC,KAAK,GAAG,MAAM,IAAI,CAACjB,QAAQ,EAAE;MACnC,OAAO;QACLkB,WAAW,EAAED,KAAK,CAACE,WAAW;QAC9BC,eAAe,EAAEH,KAAK,CAACI,eAAe;QACtCC,KAAK,EAAEL,KAAK,CAACM,YAAY;QACzBC,UAAU,EAAEP,KAAK,CAACQ;OACnB;IACH,CAAC,CAAC,OAAOC,KAAK,EAAE;MACd,MAAM,IAAIlC,OAAA,CAAAmC,aAAa,CAACD,KAAK,CAACE,OAAO,EAAE;QAAEC,KAAK,EAAEH;MAAK,CAAE,CAAC;IAC1D;EACF;;AAvGFI,OAAA,CAAArC,wBAAA,GAAAA,wBAAA","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}